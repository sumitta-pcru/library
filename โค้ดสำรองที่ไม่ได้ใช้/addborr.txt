<?php
	session_start();
    include("connect.php");  
    include("script.php");  
    include("alert.php");  
   
                                 
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title> บริการยืม-คืน |โรงเรียนวังโป่งศึกษา </title>
    <link rel="shortcut icon" type="image/x-icon" href="picture/icons.png">

</head>

<body>
<?php

$valid_uname = $_SESSION['valid_uname'];
$bw_date  = date('Y-m-d');
$bw_returndate = date("Y-m-d",strtotime("+1 weeks"));
$bw_returndate1 = date("Y-m-d",strtotime("+15 day"));
$m_id = $_POST["m_id"];
$bd_status = "1";
$bl_status = "1";
$ut_id = "4";

if ($ut_id =='4'){
	$sql4  ="SELECT t.ut_id FROM member m , usertype t 
    where m.ut_id = '$ut_id' and m.m_id = '$m_id'";
	$result4 = mysql_query($sql4,$conn);
	$total1 = mysql_num_rows($result4);
	if ($total1 == 0){

$sql	= "insert into borrowing (bw_date,bw_returndate,m_id,mw_id) VALUES ('$bw_date','$bw_returndate1','$m_id','$valid_uname')";
$result = mysql_query($sql,$conn);   
$bw_id = mysql_insert_id();//คำสั่งให้ FK อ้างถึงกันในกรณี id เป็น Auto
foreach($_SESSION['shopping_cart'] as $bl_id){
 
    $sql1 = "select * from book b inner join bookcategory bc on  b.bc_id = bc.bc_id inner join booklist bl on bl.b_id = b.b_id where bl_id='".$_SESSION['shopping_cart'][$bl_id]."'";     
    $result1 = mysql_query($sql1,$conn);   
    $row1 = mysql_fetch_array($result1);                                                 
    
        $sql2 = "insert into borrowingdetails (bd_status,bw_id,bl_id) VALUES('$bd_status','$bw_id','$bl_id')";
        $result2 = mysql_query($sql2, $conn) or die ("Error in query: $sql2 " . mysql_error());
            $sql3 = "Update booklist Set bl_status='$bl_status' Where bl_id='$bl_id'";
            $result3 = mysql_query($sql3, $conn) or die ("Error in query: $sql3 " . mysql_error());
      

        if($result && $result2){
            
            
            foreach($_SESSION['shopping_cart'] as $bl_id)
            {	
                unset($_SESSION['shopping_cart']);

            }
            
        }
    }
    echo success_h3("บันทึกข้อมูลเรียบร้อยแล้ว","showborrowing.php");
    }
    else{
        $sql	= "insert into borrowing (bw_date,bw_returndate,m_id,mw_id) VALUES ('$bw_date','$bw_returndate','$m_id','$valid_uname')";
        $result = mysql_query($sql,$conn);   
        $bw_id = mysql_insert_id();//คำสั่งให้ FK อ้างถึงกันในกรณี id เป็น Auto
        foreach($_SESSION['shopping_cart'] as $bl_id){
         
            $sql1 = "select * from book b inner join bookcategory bc on  b.bc_id = bc.bc_id inner join booklist bl on bl.b_id = b.b_id where bl_id='".$_SESSION['shopping_cart'][$bl_id]."'";     
            $result1 = mysql_query($sql1,$conn);   
            $row1 = mysql_fetch_array($result1);                                                 
            
                $sql2 = "insert into borrowingdetails (bd_status,bw_id,bl_id) VALUES('$bd_status','$bw_id','$bl_id')";
                $result2 = mysql_query($sql2, $conn) or die ("Error in query: $sql2 " . mysql_error());
                    $sql3 = "Update booklist Set bl_status='$bl_status' Where bl_id='$bl_id'";
                    $result3 = mysql_query($sql3, $conn) or die ("Error in query: $sql3 " . mysql_error());
              
        
                if($result && $result2){
                    
                    
                    foreach($_SESSION['shopping_cart'] as $bl_id)
                    {	
                        unset($_SESSION['shopping_cart']);
        
                    }
                    
                }
            }
            echo success_h3("บันทึกข้อมูลเรียบร้อยแล้ว","showborrowing.php");
        }
}


mysql_close($conn);
	
?>
</body>
</html>